name: px4 ros integration ci

on:
  push:
  pull_request:
  workflow_call:

jobs:
  px4-ros:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/derickcoder44/px4-sim-docker:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: start dds and px4
        run: |
          set -e

          LOG_DIR=/root/logs
          mkdir -p "$LOG_DIR"

          # Start DDS agent
          echo "Starting MicroXRCEAgent (PID: $DDS_PID)"
          MicroXRCEAgent udp4 -p 8888 > "$LOG_DIR/microxrce_agent.log" 2>&1 &
          DDS_PID=$!
          echo $DDS_PID > /root/.microxrce_agent.pid
          sleep 2

          # Start PX4 SITL with Gazebo
          echo "Starting PX4 SITL with Gazebo..."
          cd /root/workspace/PX4-Autopilot
          HEADLESS=1 make px4_sitl gz_x500 > "$LOG_DIR/px4_gz.log" 2>&1 &
          PX4_PID=$!
          echo $PX4_PID > /tmp/px4_pid.txt
          echo "PX4 started (PID: $PX4_PID)"

          # Wait for PX4 to initialize
          echo "Waiting for PX4 to initialize..."
          sleep 20

      - name: test ros topics
        run: |
          source /opt/ros/humble/setup.bash
          source /root/workspace/ros2_ws/install/setup.bash

          # Verify processes are still running
          if ! kill -0 $(cat /root/.microxrce_agent.pid) 2>/dev/null; then
            echo "ERROR: DDS agent is not running"
            echo "=== DDS Agent Log ==="
            cat /root/logs/microxrce_agent.log
            exit 1
          fi

          if ! kill -0 $(cat /tmp/px4_pid.txt) 2>/dev/null; then
            echo "ERROR: PX4 simulation is not running"
            echo "=== PX4 Simulation Log ==="
            tail -n 100 /root/logs/px4_gz.log
            exit 1
          fi

          echo "Both processes are running, waiting for ROS topics..."

          # Wait up to 90 seconds for the topic to appear
          if ! timeout 90 bash -c '
            source /opt/ros/humble/setup.bash
            source /root/workspace/ros2_ws/install/setup.bash
            while ! ros2 topic list | grep -q /fmu/fmu/out/sensor_combined; do
              echo "Waiting for topic /fmu/fmu/out/sensor_combined... ($(date +%H:%M:%S))"
              sleep 5
            done
          '; then
            echo "ERROR: Timeout waiting for /fmu/fmu/out/sensor_combined topic"
            echo ""
            echo "=== Available ROS 2 Topics ==="
            ros2 topic list || true
            echo ""
            echo "=== Last 100 lines of PX4 Log ==="
            tail -n 100 /root/logs/px4_gz.log
            echo ""
            echo "=== Last 50 lines of DDS Agent Log ==="
            tail -n 50 /root/logs/microxrce_agent.log
            exit 1
          fi

          echo "Topic found! Listing all available topics:"
          ros2 topic list

          echo ""
          echo "Reading from /fmu/fmu/out/sensor_combined:"
          ros2 topic echo /fmu/fmu/out/sensor_combined --once

      - name: stop px4 and dds
        if: always()
        run: |
          echo "Stopping PX4 and DDS agent..."
          if [ -f /tmp/px4_pid.txt ]; then
            kill $(cat /tmp/px4_pid.txt) 2>/dev/null || echo "PX4 process already stopped"
          fi
          if [ -f /root/.microxrce_agent.pid ]; then
            kill $(cat /root/.microxrce_agent.pid) 2>/dev/null || echo "DDS agent process already stopped"
          fi

          echo "--- Last PX4 logs ---"
          tail -n 200 /root/logs/px4_gz.log || true
          echo "--- Last DDS logs ---"
          tail -n 200 /root/logs/microxrce_agent.log || true

      - name: upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-logs
          path: |
            /root/logs/px4_gz.log
            /root/logs/microxrce_agent.log
          retention-days: 5
